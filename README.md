# ASTGNN因子挖掘模型复现

## 模型概述

本项目复现了融合基本面信息的ASTGNN（Adaptive Spatio-Temporal Graph Neural Network）因子挖掘模型，该模型来源于【东方证券】融合基本面信息的 ASTGNN 因子挖掘模型————因子选股系列之一〇四的研究工作。ASTGNN通过图神经网络架构捕捉股票间的空间相关性和时间序列特征，结合Barra基本面因子进行因子挖掘。

## 项目文件说明

### 核心模型文件

#### `ASTGNN.py`
**主要ASTGNN模型实现**
- **W2GATFactorExtractor**: W2-GAT因子提取器，包含GRU→GAT→Res-C→Full-C的完整流程
- **TimeGraphConvolution**: 时间图卷积层，实现动量效应（加法）和中性化效应（减法）
- **RelationalEmbeddingLayer**: 关系嵌入层，多层TGC处理股票关系
- **ASTGNNFactorModel**: 完整的ASTGNN模型，融合时序和横截面信息

#### `ASTGNN_Loss.py`
**专门的损失函数设计**
- **ASTGNNFactorLoss**: RankIC导向的损失函数
- 直接优化Spearman相关系数（RankIC）
- 包含分布正则化和方差稳定性约束
- 支持多期收益率的时间加权损失

#### `GAT.py`
**图注意力网络基础组件**
- **GraphAttentionLayer**: 单头图注意力层
- **MultiHeadGAT**: 多头图注意力机制
- **GAT**: 完整的图注意力网络，用于节点分类

#### `Res_C.py`
**残差连接组件**
- **BasicResidualBlock**: 基本残差块，防止梯度消失
- **ConvResidualBlock**: 卷积残差块（2D数据）
- **GraphResidualLayer**: 图网络中的残差连接
- **ResidualGAT**: 带残差连接的GAT网络

#### `Full_C.py`
**全连接层组件**
- **FullyConnectedLayer**: 标准全连接层，支持BatchNorm和多种激活函数
- **MultiLayerFullyConnected**: 多层全连接网络
- **GraphFullyConnectedLayer**: 适用于图数据的全连接层，支持LayerNorm

### 训练和评估文件

#### `ASTGNN_Training.py`（已弃用）
**基础ASTGNN训练框架**
- **ASTGNNDataset**: 数据集类，处理序列数据和目标收益率
- **ASTGNNTrainer**: 训练器类，包含完整的训练循环
- 支持早停、梯度裁剪、学习率调度
- 集成因子验证和可视化功能

#### `GPU_ASTGNN_Training.py`
**GPU优化版ASTGNN训练脚本**
- **GPUOptimizedASTGNNTrainer**: GPU优化的训练器，支持混合精度训练
- 多GPU支持和异步数据传输，大幅提升训练速度
- 优化的训练配置，专注RankIC和预测方向正确性
- 包含cuDNN自动调优、TF32加速、内存管理等GPU优化
- 循环学习率、梯度累积等高级训练策略

#### `Single_Factor_Evaluation.py`
**单因子专业评价脚本**
- **SingleFactorEvaluator**: 专业级单因子评价器
- 全面的IC分析（Pearson、Spearman、Kendall）
- 专业RankIC计算，每10日采样T+1至T+11日收益
- 分位数分组回测和风险调整收益分析
- 因子分布统计和预测性能可视化

### 数据处理文件

#### `DataPreprocessor.py`
**全面的数据预处理器**
- **ASTGNNDataPreprocessor**: 主数据预处理类
- 支持股价数据和Barra因子数据的加载和清洗
- GPU加速的数据处理和特征工程
- 序列数据创建和邻接矩阵构建
- 内存优化和大规模数据处理支持

#### `BarraFactorSimulator.py`
**Barra因子数据模拟器**
- **BarraFactorSimulator**: 无真实数据时用于模拟21个Barra风格因子
- 基于真实Barra模型的统计特性
- 生成具有时间序列连续性的因子数据
- 支持因子间相关性和非线性效应模拟

### 文档和配置文件

#### `README.md`
**项目主文档**
- 项目概述和模型架构说明
- 详细的性能指标和回测结果
- 使用方法和技术实现指南

#### `ASTGNN_Architecture_Analysis.md`
**ASTGNN架构深度分析**
- 网络结构详解和数学原理
- 时间图卷积（TGC）层的金融解释
- 加法/减法模式的理论基础
- 与传统方法的对比分析

#### `Barra.md`
**Barra因子模型说明**
- Barra CNE5/CNE6模型的21个风格因子定义
- 各因子的计算方法和金融含义
- 因子分类和统计特性

#### `requirements.txt`
**项目依赖列表**
- PyTorch 1.9.0+（深度学习框架）
- pandas、numpy（数据处理）
- scikit-learn（机器学习工具）
- matplotlib、seaborn（可视化）
- 其他必要的Python包

### 数据文件

#### `factor_analysis_data.npz`
**预处理的因子分析数据**
- 包含因子矩阵、收益率数据和元数据
- NumPy压缩格式，用于快速加载和分析

#### `barra_Exposure(2).`
**Barra因子暴露度数据**
- Parquet格式的Barra因子数据
- 包含21个风格因子的历史暴露度

#### `stock_price_vol_d.txt`
**股价和成交量数据**
- Feather格式的日频股价数据
- 包含开高低收和成交量信息

### 训练结果文件夹

#### `training_results/`
**训练结果和可视化**
- `astgnn_training_results_*.png`: 训练损失和指标图
- `enhanced_ic_analysis_*.png`: 增强IC分析图
- 各时间戳的训练结果记录

## 数据配置

### 数据源
- **股价数据**: 日频股价数据（开高低收量）
- **基本面数据**: Barra多因子模型风险因子暴露度
- **数据格式**: 股价数据采用feather格式，Barra数据采用parquet格式

### 时间范围
- **总体数据期间**: 2023年1月1日 - 2023年12月31日（完整一年，约250个交易日）
- **数据分割比例**: 70% 训练集 / 15% 验证集 / 15% 测试集
- **训练数据**: 2023年1月1日 - 2023年8月31日（约175个交易日）
- **验证数据**: 2023年9月1日 - 2023年10月15日（约32个交易日）
- **测试数据**: 2023年10月16日 - 2023年12月31日（约55个交易日）

### 股票范围
- **股票池**: 中国A股市场
- **股票数量**: 1228只（经过数据质量筛选）
- **筛选标准**: 
  - 最少30个交易日的历史数据
  - 最大缺失率不超过30%
  - 通过异常值检测和数据质量验证

## 模型架构

### ASTGNN核心组件
- **图注意力机制（GAT）**: 捕捉股票间的动态相关性
- **时间卷积网络**: 提取时间序列特征
- **自适应邻接矩阵**: 基于因子相关性动态构建股票关联图
- **多头注意力**: 增强模型的表征能力

### 模型参数
- **隐藏维度**: 64
- **注意力头数**: 8
- **图卷积层数**: 2
- **时间卷积层数**: 2
- **序列长度**: 20个交易日
- **预测时间跨度**: 10个交易日

### 训练配置
- **优化器**: AdamW
- **学习率**: 0.001
- **批次大小**: 1000
- **训练轮数**: 200 epochs
- **早停策略**: 连续10个epoch验证loss不改善
- **损失函数**: RankIC导向损失函数
  - RankIC损失权重: 5.0
  - 分布正则化权重: 1.0
  - 方差稳定性权重: 0.5

## 因子构建

### 输入特征
- **Barra风险因子**: 包含多个风格和行业因子的暴露度
- **技术指标**: 
  - 多期收益率（1日、5日、10日、20日）
  - 波动率指标（5日、20日滚动标准差）
  - 价格技术指标（移动平均线比率）
  - 成交量指标（成交量比率）
  - 动量指标（5日、20日动量）

### 目标变量
- **预测目标**: 未来10日累积收益率
- **标准化方式**: RobustScaler标准化

## 模型性能

### 最新训练结果（2023年数据）
- **数据维度**: 33个时间步 × 1228只股票 × 1个因子
- **有效样本数**: 40,524个
- **数据覆盖率**: 100%

### 因子统计特征
- **因子均值**: 0.099130
- **因子标准差**: 0.203739
- **偏度**: -0.1769
- **峰度**: -0.0724
- **分布范围**: [-0.550151, 0.667651]

### 预测性能指标
- **皮尔逊相关系数**: 0.043960 (p < 0.001)
- **斯皮尔曼相关系数**: 0.055605 (p < 0.001)
- **Kendall Tau**: 0.036465 (p < 0.001)
- **方向预测准确率**: 52.49%
- **R²分数**: -0.041491

### IC分析结果
#### 专业RankIC（每10日采样）
- **RankIC均值**: 0.227636
- **RankIC标准差**: 0.029327
- **RankIC信息比率**: 7.762009
- **RankIC胜率**: 100%
- **有效计算期数**: 3期

#### 传统IC分析
- **IC均值**: 0.047852
- **IC标准差**: 0.099390
- **IC信息比率**: 0.481458
- **IC胜率**: 72.73%

## 回测分析

### 分位数分组回测
| 分位数组 | 平均收益率 | 收益率标准差 | 样本数量 |
|---------|-----------|-------------|----------|
| Q1 (最低) | 0.071919 | 0.677554 | 8105 |
| Q2 | 0.131504 | 0.869484 | 8105 |
| Q3 | 0.143996 | 0.851618 | 8104 |
| Q4 | 0.170021 | 0.903517 | 8105 |
| Q5 (最高) | 0.175907 | 0.803281 | 8105 |

### 多空策略表现
- **Q5组收益率**: 17.59%
- **Q1组收益率**: 7.19%
- **多空收益差**: 10.40%
- **年化夏普比率**: 2.6662

### 回测参数设置
- **RankIC计算频率**: 每10个交易日
- **未来收益计算窗口**: T+1至T+11日（10个交易日）
- **分组数量**: 5个分位数组
- **重平衡频率**: 周度（每5个交易日）

## 技术实现

### 硬件要求
- **GPU**: 支持CUDA的GPU（推荐RTX 3090或以上）
- **内存**: 24GB RAM（可配置）
- **存储**: 50GB可用空间

### 软件环境
- **Python**: 3.8+
- **PyTorch**: 1.12+
- **CUDA**: 11.7+
- **其他依赖**: pandas, numpy, scikit-learn, matplotlib

### 数据预处理优化
- **CPU内存限制**: 24GB（可配置）
- **GPU内存阈值**: 80%
- **批次处理**: 支持大规模数据的分批处理
- **内存映射**: 启用内存映射优化数据加载
- **异常值处理**: 股票级别的异常值检测和缩尾处理

## 使用方法

### 1. 数据预处理
```bash
python DataPreprocessor.py
```

### 2. 模型训练
```bash
python GPU_ASTGNN_Training.py
```

### 3. 因子评估
```bash
python Single_Factor_Evaluation.py
```


## 关键改进

### 数据处理优化
- 时间范围从3个月扩展到完整一年
- CPU内存限制从6GB提升到24GB
- 修复时间序列创建失败问题
- 优化GPU/CPU混合处理策略

### 模型训练优化
- 实现RankIC导向的损失函数
- 添加动态权重调整机制
- 改进验证数据集划分策略
- 增强异常处理和错误恢复

### 因子评估增强
- 实现专业级RankIC计算
- 添加分位数分组回测
- 完善IC衰减分析
- 提供详细的可视化输出

## 模型局限性

1. **数据依赖**: 模型性能高度依赖输入数据的质量和完整性
2. **市场适应性**: 模型在不同市场环境下的稳定性需要进一步验证
3. **计算复杂度**: 图神经网络的计算复杂度较高，对硬件要求较严格
4. **过拟合风险**: 在有限的数据集上训练可能存在过拟合风险

## 参考文献

- 【东方证券】融合基本面信息的ASTGNN因子挖掘模型——因子选股系列之一〇四