# ASTGNN因子挖掘模型复现

## 模型概述

本项目复现了融合基本面信息的ASTGNN（Adaptive Spatio-Temporal Graph Neural Network）因子挖掘模型，该模型来源于【东方证券】因子选股系列之一〇四的研究工作。ASTGNN通过图神经网络架构捕捉股票间的空间相关性和时间序列特征，结合Barra基本面因子进行因子挖掘。

## 数据配置

### 数据源
- **股价数据**: 日频股价数据（开高低收量）
- **基本面数据**: Barra多因子模型风险因子暴露度
- **数据格式**: 股价数据采用feather格式，Barra数据采用parquet格式

### 时间范围
- **总体数据期间**: 2023年1月1日 - 2023年12月31日（完整一年，约250个交易日）
- **数据分割比例**: 70% 训练集 / 15% 验证集 / 15% 测试集
- **训练数据**: 2023年1月1日 - 2023年8月31日（约175个交易日）
- **验证数据**: 2023年9月1日 - 2023年10月15日（约32个交易日）
- **测试数据**: 2023年10月16日 - 2023年12月31日（约55个交易日）

### 股票范围
- **股票池**: 中国A股市场
- **股票数量**: 1228只（经过数据质量筛选）
- **筛选标准**: 
  - 最少30个交易日的历史数据
  - 最大缺失率不超过30%
  - 通过异常值检测和数据质量验证

## 模型架构

### ASTGNN核心组件
- **图注意力机制（GAT）**: 捕捉股票间的动态相关性
- **时间卷积网络**: 提取时间序列特征
- **自适应邻接矩阵**: 基于因子相关性动态构建股票关联图
- **多头注意力**: 增强模型的表征能力

### 模型参数
- **隐藏维度**: 64
- **注意力头数**: 8
- **图卷积层数**: 2
- **时间卷积层数**: 2
- **序列长度**: 20个交易日
- **预测时间跨度**: 10个交易日

### 训练配置
- **优化器**: AdamW
- **学习率**: 0.001
- **批次大小**: 1000
- **训练轮数**: 200 epochs
- **早停策略**: 连续10个epoch验证loss不改善
- **损失函数**: RankIC导向损失函数
  - RankIC损失权重: 5.0
  - 分布正则化权重: 1.0
  - 方差稳定性权重: 0.5

## 因子构建

### 输入特征
- **Barra风险因子**: 包含多个风格和行业因子的暴露度
- **技术指标**: 
  - 多期收益率（1日、5日、10日、20日）
  - 波动率指标（5日、20日滚动标准差）
  - 价格技术指标（移动平均线比率）
  - 成交量指标（成交量比率）
  - 动量指标（5日、20日动量）

### 目标变量
- **预测目标**: 未来10日累积收益率
- **标准化方式**: RobustScaler标准化

## 模型性能

### 最新训练结果（2023年数据）
- **数据维度**: 33个时间步 × 1228只股票 × 1个因子
- **有效样本数**: 40,524个
- **数据覆盖率**: 100%

### 因子统计特征
- **因子均值**: 0.099130
- **因子标准差**: 0.203739
- **偏度**: -0.1769
- **峰度**: -0.0724
- **分布范围**: [-0.550151, 0.667651]

### 预测性能指标
- **皮尔逊相关系数**: 0.043960 (p < 0.001)
- **斯皮尔曼相关系数**: 0.055605 (p < 0.001)
- **Kendall Tau**: 0.036465 (p < 0.001)
- **方向预测准确率**: 52.49%
- **R²分数**: -0.041491

### IC分析结果
#### 专业RankIC（每10日采样）
- **RankIC均值**: 0.227636
- **RankIC标准差**: 0.029327
- **RankIC信息比率**: 7.762009
- **RankIC胜率**: 100%
- **有效计算期数**: 3期

#### 传统IC分析
- **IC均值**: 0.047852
- **IC标准差**: 0.099390
- **IC信息比率**: 0.481458
- **IC胜率**: 72.73%

## 回测分析

### 分位数分组回测
| 分位数组 | 平均收益率 | 收益率标准差 | 样本数量 |
|---------|-----------|-------------|----------|
| Q1 (最低) | 0.071919 | 0.677554 | 8105 |
| Q2 | 0.131504 | 0.869484 | 8105 |
| Q3 | 0.143996 | 0.851618 | 8104 |
| Q4 | 0.170021 | 0.903517 | 8105 |
| Q5 (最高) | 0.175907 | 0.803281 | 8105 |

### 多空策略表现
- **Q5组收益率**: 17.59%
- **Q1组收益率**: 7.19%
- **多空收益差**: 10.40%
- **年化夏普比率**: 2.6662

### 回测参数设置
- **RankIC计算频率**: 每10个交易日
- **未来收益计算窗口**: T+1至T+11日（10个交易日）
- **分组数量**: 5个分位数组
- **重平衡频率**: 周度（每5个交易日）

## 技术实现

### 硬件要求
- **GPU**: 支持CUDA的GPU（推荐RTX 3090或以上）
- **内存**: 24GB RAM（可配置）
- **存储**: 50GB可用空间

### 软件环境
- **Python**: 3.8+
- **PyTorch**: 1.12+
- **CUDA**: 11.7+
- **其他依赖**: pandas, numpy, scikit-learn, matplotlib

### 数据预处理优化
- **CPU内存限制**: 24GB（可配置）
- **GPU内存阈值**: 80%
- **批次处理**: 支持大规模数据的分批处理
- **内存映射**: 启用内存映射优化数据加载
- **异常值处理**: 股票级别的异常值检测和缩尾处理

## 使用方法

### 1. 数据预处理
```bash
python DataPreprocessor.py
```

### 2. 模型训练
```bash
python GPU_ASTGNN_Training.py
```

### 3. 因子评估
```bash
python Single_Factor_Evaluation.py
```


## 关键改进

### 数据处理优化
- 时间范围从3个月扩展到完整一年
- CPU内存限制从6GB提升到24GB
- 修复时间序列创建失败问题
- 优化GPU/CPU混合处理策略

### 模型训练优化
- 实现RankIC导向的损失函数
- 添加动态权重调整机制
- 改进验证数据集划分策略
- 增强异常处理和错误恢复

### 因子评估增强
- 实现专业级RankIC计算
- 添加分位数分组回测
- 完善IC衰减分析
- 提供详细的可视化输出

## 模型局限性

1. **数据依赖**: 模型性能高度依赖输入数据的质量和完整性
2. **市场适应性**: 模型在不同市场环境下的稳定性需要进一步验证
3. **计算复杂度**: 图神经网络的计算复杂度较高，对硬件要求较严格
4. **过拟合风险**: 在有限的数据集上训练可能存在过拟合风险

## 参考文献

- 【东方证券】融合基本面信息的ASTGNN因子挖掘模型——因子选股系列之一〇四